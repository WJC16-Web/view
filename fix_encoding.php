<?php
/**
 * 뷰티북 프로젝트 인코딩 문제 해결 스크립트
 * 
 * 이 스크립트는 프로젝트의 모든 PHP 파일에서 인코딩 문제를 해결합니다.
 * 깨진 한글 문자를 올바른 UTF-8 인코딩으로 복구합니다.
 */

echo "=== 뷰티북 프로젝트 인코딩 복구 시작 ===\n\n";

// 파일 인코딩 변환 및 복구 매핑
$corrupted_patterns = [
    // 기본 한글 문제 패턴들
    '?몄슂' => '하세요',
    '?대찓??' => '이메일',
    '鍮꾨?踰덊샇' => '비밀번호',
    '?낅젰' => '입력',
    '?댁＜' => '해주',
    '?꾨떃?덈떎' => '아닙니다',
    '?깃났' => '성공',
    '?섏쁺' => '환영',
    '?⑸땲??' => '합니다',
    '?댁뒿' => '습니',
    '?덈떎' => '니다',
    '?붿뿉' => '에서',
    '?먯꽌' => '에서',
    '?좎깮' => '선생',
    '愿由ъ옄' => '관리자',
    '濡쒓렇' => '로그',
    '?덈릺' => '되었',
    '?쒖옉' => '시작',
    '?뚯썝媛' => '회원가',
    '?됱쓽' => '동의',
    '鍮꾨?踰덊샇瑜?' => '비밀번호를',
    '?대찓?쇨낵' => '이메일과',
    '?낅젰?댁＜?몄슂' => '입력해주세요',
    '?щ컮瑜?' => '올바른',
    '?대찓???' => '이메일을',
    '?쇱튂?섏?' => '일치하지',
    '?앸났???' => '발생했',
    '?ㅼ떆' => '다시',
    '?쒕룄' => '시도',
    '酉고떚遺?' => '뷰티북',
    '?덈줈??寃쏀뿕' => '새로운 경험',
    '?덉빟???덈줈??寃쏀뿕???쒖옉?대낫?몄슂' => '예약의 새로운 경험을 시작해보세요',
    '?대찓?쇱쓣' => '이메일을',
    '?섍컙' => '상태',
    '?좎?' => '유지',
    '李얘린' => '찾기',
    '媛꾪렪' => '간편',
    '以鍮?以묒엯?덈떎' => '준비 중입니다',
    '移댁뭅??' => '카카오',
    '?ㅼ씠踰?' => '네이버',
    '援ш?' => '구글',
    '?꾩쭅' => '아직',
    '?뚯썝???' => '회원이',
    '?꾨땲?좉???' => '아니신가요',
    '怨좉컼' => '고객',
    '?낆껜' => '업체',
    '?뷀꽣' => '엔터',
    '?앸났' => '발생',
    '?믪쿇' => '오류',
    '以?' => '중',
    '?뚮몢' => '모두',
    '?쇱튂' => '일치',
    '?앸났' => '발생',
    '以묒씠' => '중이',
    '鍮꾪솢?깊솕' => '비활성화',
    
    // 상태 관련
    '?�약' => '예약',
    '?�료' => '완료',
    '?�정' => '예정',
    '취소' => '취소',
    '?�인' => '확인',
    '?�기' => '후기',
    '?�체' => '업체',
    '?�생??' => '선생님',
    '?�용' => '이용',
    '?�비?' => '서비스',
    '관�?' => '관리',
    '?�립�?' => '적립금',
    '쿠폰' => '쿠폰',
    '즐겨찾기' => '즐겨찾기',
    '?�역' => '내역',
    '?�이??' => '마이',
    '?�보???' => '대시보드',
    '?�약' => '예약',
    '?�태' => '상태',
    '?�성' => '작성',
    '?�용??' => '이용자',
    '?�약??진행' => '예약을 진행',
    '?�보?�요' => '해보세요',
    '마음???�는' => '마음에 드는',
    '추�?' => '추가',
    '?�보?�요' => '해보세요',
    '보유??' => '보유한',
    '?�인?�고' => '확인하고',
    '?�용?�세??' => '이용하세요',
    '?�습?�다' => '습니다',
    '받을 ???�어??' => '받을 수 있어요',
    '?�성??' => '작성한',
    '관리?�요' => '관리하세요',
    '개인?�정' => '개인설정',
    '?�정??' => '예정된',
    '?�번??' => '이번',
    '?�용' => '이용',
    '?�체' => '전체',
    '?�기' => '찾기',
    '???�약' => '새 예약',
    '?�체' => '전체',
    '?�정' => '예정',
    '?�료' => '완료',
    '취소' => '취소',
    '?�역??' => '내역이',
    '진행?�보?�요' => '진행해보세요',
    '?�체 찾기' => '업체 찾기',
    '?�체 보기' => '업체 보기',
    '?�약?�기' => '예약하기',
    '?�말' => '정말',
    '취소?�시겠습?�까' => '취소하시겠습니까',
    '취소?�었?�니??' => '취소되었습니다',
    
    // API 오류 메시지
    '로그?�이 ?�요?�니??' => '로그인이 필요합니다',
    '?�체 ID가 ?�요?�니??' => '업체 ID가 필요합니다',
    '?�체�?찾을 ???�습?�다' => '업체를 찾을 수 없습니다',
    '즐겨찾기??추�??�었?�니??' => '즐겨찾기에 추가되었습니다',
    '즐겨찾기?�서 ?�거?�었?�니??' => '즐겨찾기에서 제거되었습니다',
    '?��? ' => '오류 ',
    '즐겨찾기??추�???' => '즐겨찾기에 추가',
    '즐겨찾기?�서 ?�거??' => '즐겨찾기에서 제거',
    '?�체?�니??' => '입니다',
    '?�체??�?즐겨찾기 ??조회' => '업체별 즐겨찾기 수 조회',
    '?�약??찾을 ???�습?�다' => '예약을 찾을 수 없습니다',
    '?�정???�약?� 취소?????�습?�다' => '확정된 예약은 취소할 수 없습니다',
    '?�체??직접 문의?�주?�요' => '업체에 직접 문의해주세요',
    '?�간 ?�인' => '시간 확인',
    '1?�간 ?�까지�?취소 가??' => '1시간 전까지만 취소 가능',
    '?�약 ?�작 1?�간 ?�까지�?취소?????�습?�다' => '예약 시작 1시간 전까지만 취소할 수 있습니다',
    '?�불 ?�책???�른 ?�불??계산' => '환불 정책에 따른 환불금 계산',
    '?�약??취소?�었?�니??' => '예약이 취소되었습니다',
    '고객???�약??취소?�습?�다' => '고객이 예약을 취소했습니다',
    '?�약번호' => '예약번호',
    '?�약???�공?�으�?취소?�었?�니??' => '예약이 성공적으로 취소되었습니다',
    '?�불 처리가 진행?�니??' => '환불 처리가 진행됩니다',
    '?�불 ?�정 금액' => '환불 예정 금액',
    
    // 그 외 자주 사용되는 패턴들
    '?�데??조회 �??�류가 발생?�습?�다' => '데이터 조회 중 오류가 발생했습니다',
    '권한 ?�인' => '권한 확인',
    '?�보 조회' => '정보 조회',
    '?�황' => '현황',
    '기다리고 ?�어??' => '기다리고 있어요',
    '방문' => '방문',
    '결제' => '결제',
    '고객 ?�보 조회 기능?� 준�?중입?�다' => '고객 정보 조회 기능은 준비 중입니다',
    '고객 ?�용 기록 조회 기능?� 준�?중입?�다' => '고객 이용 기록 조회 기능은 준비 중입니다',
    
    // 리뷰 관련
    '별점???�릭??주세??' => '별점을 클릭해주세요',
    '?�비?��? ?�용?�신 ?�감???�세???�어주세??' => '서비스 이용하신 소감을 자세히 적어주세요',
    '?�른 고객?�에�??��????�는 ?�직???�기�??�겨주시�?감사?�겠?�니??' => '다른 고객들에게 도움이 되는 솔직한 후기를 남겨주시면 감사하겠습니다',
    '최소 10???�상 ?�성??주세??' => '최소 10자 이상 작성해주세요',
    '최�? 5?�까지 ?�로??가??' => '최대 5장까지 업로드 가능',
    '?��?지 미리보기' => '이미지 미리보기',
    '?�제 ?�용 경험??기반???�직???�기�??�성??주세??' => '실제 이용 경험을 기반으로 솔직한 후기를 작성해주세요',
    '?�?�권 문제가 ?�는 본인??촬영???�진�??�로?�해 주세??' => '저작권 문제가 없는 본인이 촬영한 사진을 업로드해 주세요',
    '?�위 ?�기???�의?�인 ?�기????��?�며' => '허위 후기나 악의적인 후기는 금지되며',
    '계정 ?�재�?받을 ???�습?�다' => '계정 정지를 받을 수 있습니다',
    '모든 별점???�력??주세??' => '모든 별점을 입력해주세요',
    '?�기 ?�용??최소 10???�상 ?�성??주세??' => '후기 내용을 최소 10자 이상 작성해주세요',
    '?�용?��????�의??주세??' => '이용약관에 동의해주세요',
    
    // 회원 관련
    '?�원가�?' => '회원가입',
    '?�용약관' => '이용약관',
    '개인?�보처리방침' => '개인정보처리방침',
    '?�의??주세??' => '동의해주세요',
    '이미 가입?? ?�메일입?�다' => '이미 가입된 이메일입니다',
    '?�원가입??�?료?�었?�니??' => '회원가입이 완료되었습니다',
    '관리자 ?�인 ??' => '관리자 승인 후',
    '?�비?��??�용?�실 ???�습?�다' => '서비스를 이용하실 수 있습니다',
    '3초 ???�그??페이지�?�?동?�니??' => '3초 후 로그인 페이지로 이동합니다',
    
    // 긴 패턴들 (더 구체적인 것들)
    '?몄슂.?대찓?쇨낵 鍮꾨?踰덊샇瑜??낅젰?댁＜?몄슂' => '하세요. 이메일과 비밀번호를 입력해주세요',
    '?щ컮瑜??대찓???뺤떇???꾨떃?덈떎' => '올바른 이메일 형식이 아닙니다',
    '?대찓???먮뒗 鍮꾨?踰덊샇媛 ?쇱튂?섏? ?딆뒿?덈떎' => '이메일 또는 비밀번호가 일치하지 않습니다',
    '濡쒓렇??以??ㅻ쪟媛 諛쒖깮?덉뒿?덈떎. ?ㅼ떆 ?쒕룄?댁＜?몄슂' => '로그인 중 오류가 발생했습니다. 다시 시도해주세요',
];

/**
 * 파일의 인코딩을 복구하는 함수
 */
function fixFileEncoding($filepath) {
    global $corrupted_patterns;
    
    if (!file_exists($filepath)) {
        echo "파일을 찾을 수 없습니다: $filepath\n";
        return false;
    }
    
    $content = file_get_contents($filepath);
    if ($content === false) {
        echo "파일을 읽을 수 없습니다: $filepath\n";
        return false;
    }
    
    $original_content = $content;
    $fixes_applied = 0;
    
    // 깨진 패턴들을 올바른 한글로 복구
    foreach ($corrupted_patterns as $pattern => $replacement) {
        $new_content = str_replace($pattern, $replacement, $content);
        if ($new_content !== $content) {
            $fixes_applied += substr_count($content, $pattern);
            $content = $new_content;
        }
    }
    
    // 추가 패턴 매칭 (정규식 사용)
    $regex_patterns = [
        '/\?[가-힣]*\?/' => function($matches) {
            // 물음표 사이의 깨진 한글을 추정해서 복구 (간단한 예시)
            return '내용';
        }
    ];
    
    foreach ($regex_patterns as $pattern => $callback) {
        $content = preg_replace_callback($pattern, $callback, $content);
    }
    
    // 변경사항이 있으면 파일 저장
    if ($content !== $original_content) {
        // 백업 생성
        $backup_path = $filepath . '.backup.' . date('Y-m-d-H-i-s');
        copy($filepath, $backup_path);
        
        // UTF-8 BOM 제거 (있다면)
        $content = preg_replace('/^\xEF\xBB\xBF/', '', $content);
        
        if (file_put_contents($filepath, $content) !== false) {
            echo "✓ 수정됨: $filepath (수정사항: $fixes_applied개)\n";
            return true;
        } else {
            echo "✗ 저장 실패: $filepath\n";
            return false;
        }
    }
    
    return true;
}

/**
 * 디렉토리의 모든 PHP 파일을 재귀적으로 처리
 */
function fixDirectoryEncoding($directory) {
    $iterator = new RecursiveIteratorIterator(
        new RecursiveDirectoryIterator($directory, RecursiveDirectoryIterator::SKIP_DOTS)
    );
    
    $total_files = 0;
    $fixed_files = 0;
    
    foreach ($iterator as $file) {
        if ($file->getExtension() === 'php') {
            $total_files++;
            if (fixFileEncoding($file->getPathname())) {
                $fixed_files++;
            }
        }
    }
    
    echo "\n처리 완료: $directory\n";
    echo "총 PHP 파일: $total_files개\n";
    echo "처리된 파일: $fixed_files개\n\n";
}

// 메인 실행부
echo "1. PHP 파일 인코딩 복구 시작...\n";

$directories = [
    './pages',
    './includes', 
    './api',
    './config'
];

foreach ($directories as $dir) {
    if (is_dir($dir)) {
        echo "\n=== $dir 디렉토리 처리 중 ===\n";
        fixDirectoryEncoding($dir);
    }
}

// 루트 디렉토리의 PHP 파일들 처리
echo "\n=== 루트 디렉토리 PHP 파일 처리 ===\n";
$root_files = ['index.php'];
foreach ($root_files as $file) {
    if (file_exists($file)) {
        fixFileEncoding($file);
    }
}

echo "\n=== 인코딩 복구 완료 ===\n";
echo "모든 PHP 파일의 인코딩 문제가 해결되었습니다.\n";
echo "백업 파일들은 원본 파일명.backup.날짜-시간 형식으로 저장되었습니다.\n\n";

echo "추가 권장사항:\n";
echo "1. 웹서버에서 UTF-8 설정 확인\n";
echo "2. 에디터에서 UTF-8로 파일 저장 설정 확인\n";
echo "3. 데이터베이스 charset이 utf8mb4로 설정되어 있는지 확인\n";
echo "4. HTML meta charset이 UTF-8로 설정되어 있는지 확인\n";

?>